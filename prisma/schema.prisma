// Configuración de conexión para PostgreSQL (Neon)
datasource db {
  provider = "postgresql"
  url = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

// --- Enums ---

enum Role {
  ADMIN
  SOPORTE
  DESARROLLO
  VENTAS
  CONTACTO_CLIENTE
}

enum Priority {
  BAJA
  MEDIA
  ALTA
  URGENTE
}

enum Category {
  SOPORTE
  DESARROLLO
  VENTAS
}

enum TicketStatus {
  PENDIENTE
  EN_PROCESO
  ESCALADO
  RESUELTO
  CANCELADO
  CERRADO
}

// --- Modelos de Identidad y Empresas ---

model ProviderCompany {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  
  users     User[]   
  clients   ClientCompany[] 
  tickets   Ticket[]        
}

model ClientCompany {
  id                String          @id @default(cuid())
  name              String
  createdAt         DateTime        @default(now())
  isActive          Boolean         @default(true)
  
  // Estandarizado a providerId
  providerId        String
  provider          ProviderCompany @relation(fields: [providerId], references: [id])
  
  contacts          User[]          
  tickets           Ticket[]
}

model User {
  id              String         @id @default(cuid())
  name            String?
  email           String         @unique
  password        String
  role            Role           @default(CONTACTO_CLIENTE)
  createdAt       DateTime       @default(now())
  isActive        Boolean        @default(true)

  // Estandarizado: providerId para empleados del servicio
  providerId      String?
  provider        ProviderCompany? @relation(fields: [providerId], references: [id])
  
  // Estandarizado: clientId para contactos de empresas cliente
  clientId        String?
  client          ClientCompany?   @relation(fields: [clientId], references: [id])

  assignedTickets Ticket[]         @relation("AssignedUser")
  assignedTicketsHistory TicketHistory[]         @relation("AssignedUserHistory")
  createdTickets  Ticket[]         @relation("CreatorUser")
  registeredTickets  Ticket[]         @relation("TicketRegistrar")
  historyEntries  TicketHistory[]
}

// --- Modelos de Negocio (Tickets) ---

model Ticket {
  id              String         @id @default(cuid())
  folio           String         @unique
  sequence        Int
  title           String
  description     String
  status          TicketStatus   @default(PENDIENTE)
  priority        Priority       @default(MEDIA)
  category        Category
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Llaves foráneas estandarizadas
  providerId      String
  provider        ProviderCompany @relation(fields: [providerId], references: [id])

  clientId        String
  client          ClientCompany  @relation(fields: [clientId], references: [id])

  creatorId       String
  creator         User           @relation("CreatorUser", fields: [creatorId], references: [id])

  createdById     String
  createdBy       User           @relation("TicketRegistrar", fields: [createdById], references: [id])

  assignedToId    String?
  assignedTo      User?          @relation("AssignedUser", fields: [assignedToId], references: [id])

  attachments     Json?

  history         TicketHistory[]
}

model TicketSequence {
  category        Category @id
  nextVal         Int      @default(1)
}

model TicketHistory {
  id          String       @id @default(cuid())
  createdAt   DateTime     @default(now())
  
  ticketId    String
  ticket      Ticket       @relation(fields: [ticketId], references: [id])
  
  userId      String       // Quién realiza la acción
  user        User         @relation(fields: [userId], references: [id])
  
  status      TicketStatus
  comment     String?      @db.Text
  attachments Json?        // Para nuevos adjuntos en esta actualización
  isInternal  Boolean      @default(false)

  // --- NUEVOS CAMPOS PARA RASTREAR CAMBIOS ---
  assignedToId String?     // Si se cambió el asignado en este paso
  assignedTo   User?       @relation("AssignedUserHistory", fields: [assignedToId], references: [id])
  priority     Priority?   // Si se cambió la prioridad en este paso
  category     Category?   // Si se cambió la categoría en este paso
}